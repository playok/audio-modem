<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Modem</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f0f23; color: #e0e0e0; min-height: 100vh; }
        .container { max-width: 640px; margin: 0 auto; padding: 16px; }

        header { text-align: center; padding: 16px 0; }
        h1 { font-size: 1.8rem; color: #00d4ff; margin-bottom: 2px; }
        .subtitle { color: #888; font-size: 0.85rem; }
        .badge { display: inline-block; margin-top: 8px; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; background: rgba(0,212,255,0.15); color: #00d4ff; }

        .card { background: #1a1a2e; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid #2a2a4a; }
        .card h2 { font-size: 1rem; margin-bottom: 10px; color: #00d4ff; }

        .mode-selector { display: flex; gap: 10px; }
        .mode-btn { flex: 1; padding: 14px; border: 2px solid #2a2a4a; border-radius: 10px; background: transparent; color: #888; cursor: pointer; font-size: 0.95rem; display: flex; flex-direction: column; align-items: center; gap: 6px; transition: all 0.2s; }
        .mode-btn:hover { border-color: #00d4ff; color: #e0e0e0; }
        .mode-btn.active { border-color: #00d4ff; background: rgba(0,212,255,0.1); color: #00d4ff; }
        .mode-btn .icon { font-size: 1.4rem; }

        .setting-row { display: flex; align-items: center; justify-content: space-between; }
        .setting-row label { font-size: 0.9rem; color: #aaa; }
        .setting-row select { background: #0f0f23; color: #e0e0e0; border: 1px solid #2a2a4a; border-radius: 6px; padding: 8px 12px; font-size: 0.85rem; }

        .upload-area { border: 2px dashed #2a2a4a; border-radius: 10px; padding: 24px; text-align: center; cursor: pointer; position: relative; margin-bottom: 12px; transition: all 0.2s; }
        .upload-area:hover { border-color: #00d4ff; background: rgba(0,212,255,0.05); }
        .upload-area input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .upload-icon { font-size: 1.8rem; display: block; margin-bottom: 6px; }
        .upload-area p { color: #888; font-size: 0.85rem; }
        .file-info { color: #00d4ff !important; font-weight: 500; margin-top: 6px; }

        .primary-btn { width: 100%; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, #00d4ff, #0099cc); color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .primary-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(0,212,255,0.3); }
        .primary-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .primary-btn.recording { background: linear-gradient(135deg, #ff4444, #cc0000); animation: pulse-btn 1.5s infinite; }
        @keyframes pulse-btn { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }

        .progress-bar { height: 8px; background: #0f0f23; border-radius: 4px; overflow: hidden; margin-bottom: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #00d4ff, #00ff88); border-radius: 4px; transition: width 0.3s; width: 0%; }
        .progress-info { display: flex; justify-content: space-between; font-size: 0.85rem; color: #aaa; }
        .progress-message { margin-top: 6px; font-size: 0.85rem; color: #888; }

        .log-container { max-height: 200px; overflow-y: auto; font-family: 'SF Mono', Monaco, Consolas, monospace; font-size: 0.75rem; line-height: 1.5; }
        .log-entry { padding: 2px 0; border-bottom: 1px solid rgba(42,42,74,0.5); }
        .log-entry.info { color: #888; } .log-entry.warn { color: #ffaa00; } .log-entry.error { color: #ff4444; } .log-entry.success { color: #00ff88; }

        .file-item { display: flex; align-items: center; padding: 10px; background: #0f0f23; border-radius: 8px; margin-top: 8px; }
        .download-link { color: #00d4ff; text-decoration: none; font-size: 0.9rem; }
        .download-link:hover { text-decoration: underline; }

        .info-box { background: rgba(0,212,255,0.08); border: 1px solid rgba(0,212,255,0.2); border-radius: 8px; padding: 10px 14px; margin-bottom: 12px; font-size: 0.8rem; color: #aaa; line-height: 1.6; }
        .info-box strong { color: #00d4ff; }

        #level-canvas, #waveform-canvas {
            width: 100%; background: #0f0f23;
            border-radius: 6px; border: 1px solid #2a2a4a;
        }
        #level-meter-container { margin-bottom: 12px; }
        #waveform-container { margin-top: 12px; }
        .trim-controls { display: flex; gap: 8px; margin: 8px 0; }
        .trim-controls input[type="range"] { flex: 1; accent-color: #00d4ff; }
        .trim-info { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-bottom: 10px; }
        #btn-demodulate { margin-top: 4px; }

        .recv-mode-selector { display: flex; gap: 6px; margin-bottom: 12px; }
        .recv-mode-btn { flex: 1; padding: 8px 12px; border: 1px solid #2a2a4a; border-radius: 8px; background: transparent; color: #888; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; }
        .recv-mode-btn:hover { border-color: #00d4ff; color: #ccc; }
        .recv-mode-btn.active { border-color: #00d4ff; background: rgba(0,212,255,0.1); color: #00d4ff; }

        #chunk-progress { margin-top: 12px; }
        .chunk-stats { display: flex; justify-content: space-between; font-size: 0.8rem; color: #aaa; margin-bottom: 8px; }
        #chunk-bitmap-canvas { width: 100%; height: 40px; background: #0f0f23; border-radius: 4px; border: 1px solid #2a2a4a; }
        #chunk-filename { margin-top: 6px; font-size: 0.85rem; color: #00d4ff; }

        .test-buttons { display: flex; gap: 8px; margin-bottom: 12px; }
        .test-btn { flex: 1; padding: 10px; border: 1px solid #2a2a4a; border-radius: 8px;
            background: transparent; color: #aaa; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
        .test-btn:hover { border-color: #00d4ff; color: #e0e0e0; }
        .test-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .test-result-box { margin-top: 10px; padding: 12px; border-radius: 8px;
            background: rgba(0,212,255,0.05); border: 1px solid #2a2a4a; }
        .quality-badge { display: inline-block; padding: 4px 12px; border-radius: 12px;
            font-size: 0.8rem; font-weight: 600; }
        .quality-excellent { background: rgba(0,255,136,0.15); color: #00ff88; }
        .quality-good { background: rgba(255,170,0,0.15); color: #ffaa00; }
        .quality-poor { background: rgba(255,68,68,0.15); color: #ff4444; }
        #test-spectrum-canvas, #test-channel-canvas {
            width: 100%; background: #0f0f23;
            border-radius: 6px; border: 1px solid #2a2a4a; margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Audio Modem</h1>
            <p class="subtitle">ìŠ¤í”¼ì»¤ì™€ ë§ˆì´í¬ë¡œ íŒŒì¼ì„ ì „ì†¡í•©ë‹ˆë‹¤</p>
            <span class="badge">ì„œë²„ ë¶ˆí•„ìš” â€” ë¸Œë¼ìš°ì €ë§Œìœ¼ë¡œ ë™ì‘</span>
        </header>

        <main>
            <div class="info-box">
                <strong>ì‚¬ìš©ë²•:</strong> ì†¡ì‹ ì¸¡ì€ <strong>íŒŒì¼ ì „ì†¡</strong>, ìˆ˜ì‹ ì¸¡ì€ <strong>íŒŒì¼ ìˆ˜ì‹ </strong>ì„ ì„ íƒí•˜ì„¸ìš”.<br>
                ìˆ˜ì‹ ì¸¡ì´ ë¨¼ì € <strong>ìˆ˜ì‹  ëŒ€ê¸°</strong>ë¥¼ ëˆ„ë¥¸ í›„, ì†¡ì‹ ì¸¡ì´ <strong>ì „ì†¡ ì‹œì‘</strong>ì„ ëˆ„ë¥´ì„¸ìš”.<br>
                ì™„ë£Œ í›„ ìˆ˜ì‹ ì¸¡ì—ì„œ <strong>ìˆ˜ì‹  ì¤‘ì§€</strong>ë¥¼ ëˆ„ë¥´ë©´ ë³µì¡°ê°€ ì‹œì‘ë©ë‹ˆë‹¤.
            </div>

            <div class="card">
                <h2>ëª¨ë“œ</h2>
                <div class="mode-selector">
                    <button id="btn-send-mode" class="mode-btn active" onclick="setMode('send')">
                        <span class="icon">ğŸ”Š</span><span>íŒŒì¼ ì „ì†¡</span>
                    </button>
                    <button id="btn-recv-mode" class="mode-btn" onclick="setMode('receive')">
                        <span class="icon">ğŸ™ï¸</span><span>íŒŒì¼ ìˆ˜ì‹ </span>
                    </button>
                </div>
            </div>

            <div class="card">
                <h2>ì„¤ì •</h2>
                <div class="setting-row">
                    <label for="modulation">ë³€ì¡° ë°©ì‹</label>
                    <select id="modulation">
                        <option value="QPSK" selected>QPSK (~2.5 KB/s, ì¼€ì´ë¸”)</option>
                        <option value="16-QAM">16-QAM (~5 KB/s, ì¼€ì´ë¸”/ê³ ì†)</option>
                        <option value="BPSK-ACOUSTIC">BPSK (~0.5 KB/s, ìŠ¤í”¼ì»¤â†’ë§ˆì´í¬)</option>
                        <option value="BPSK-REPEAT">BPSK-ë°˜ë³µ (~170 B/s, ê³ ì‹ ë¢°)</option>
                        <option value="BPSK-NARROW">í˜‘ëŒ€ì—­ (~100 B/s, ìµœê³  ì•ˆì •)</option>
                    </select>
                </div>
                <div class="setting-row" style="margin-top:10px">
                    <label for="max-duration">ìµœëŒ€ ë…¹ìŒ</label>
                    <select id="max-duration">
                        <option value="120">2ë¶„ (~20MB RAM)</option>
                        <option value="300">5ë¶„ (~50MB RAM)</option>
                        <option value="600" selected>10ë¶„ (~100MB RAM)</option>
                        <option value="1200">20ë¶„ (~200MB RAM)</option>
                    </select>
                </div>
                <p id="modulation-info" style="margin-top:8px; font-size:0.8rem; color:#888; line-height:1.5"></p>
            </div>

            <div class="card" id="test-panel">
                <h2>ì‚¬ì „ í…ŒìŠ¤íŠ¸</h2>
                <p style="color:#888; font-size:0.85rem; margin-bottom:12px">
                    ì „ì†¡ ì „ì— ì˜¤ë””ì˜¤ ê²½ë¡œì˜ ìŒëŸ‰ê³¼ í’ˆì§ˆì„ í™•ì¸í•˜ì„¸ìš”.
                </p>
                <div class="test-buttons">
                    <button class="test-btn" onclick="runOutputTest()">ğŸ”Š ì¶œë ¥</button>
                    <button class="test-btn" onclick="runInputTest()">ğŸ™ï¸ ì…ë ¥</button>
                    <button class="test-btn" onclick="runLoopbackTest()">ğŸ”„ ë£¨í”„ë°±</button>
                </div>
                <canvas id="test-spectrum-canvas" height="100" style="display:none"></canvas>
                <canvas id="test-channel-canvas" height="100" style="display:none"></canvas>
                <div id="test-result" style="display:none"></div>
            </div>

            <div id="send-panel" class="card">
                <h2>íŒŒì¼ ì „ì†¡ (ìŠ¤í”¼ì»¤ ì¶œë ¥)</h2>
                <div class="upload-area" id="upload-area">
                    <input type="file" id="file-input" onchange="handleFileSelect(event)">
                    <div>
                        <span class="upload-icon">ğŸ“</span>
                        <p>íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</p>
                        <p id="file-info" class="file-info"></p>
                    </div>
                </div>
                <button id="btn-send" class="primary-btn" onclick="startSend()" disabled>ì „ì†¡ ì‹œì‘</button>
            </div>

            <div id="receive-panel" class="card" style="display:none">
                <h2>íŒŒì¼ ìˆ˜ì‹  (ë§ˆì´í¬ ì…ë ¥)</h2>

                <div class="recv-mode-selector">
                    <button id="recv-mode-manual" class="recv-mode-btn active" onclick="setReceiveMode('manual')">ìˆ˜ë™ (íŠ¸ë¦¼)</button>
                    <button id="recv-mode-streaming" class="recv-mode-btn" onclick="setReceiveMode('streaming')">ìŠ¤íŠ¸ë¦¬ë° (ì‹¤ì‹œê°„)</button>
                </div>

                <div id="recv-manual-desc" style="color:#888; font-size:0.85rem; margin-bottom:12px">
                    ìˆ˜ì‹  ëŒ€ê¸°ë¥¼ ëˆ„ë¥´ë©´ ë§ˆì´í¬ ê¶Œí•œì„ ìš”ì²­í•©ë‹ˆë‹¤.<br>
                    ì†¡ì‹  ì™„ë£Œ í›„ <strong>ìˆ˜ì‹  ì¤‘ì§€</strong>ë¥¼ ëˆŒëŸ¬ ë³µì¡°í•˜ì„¸ìš”.
                </div>
                <div id="recv-streaming-desc" style="color:#888; font-size:0.85rem; margin-bottom:12px; display:none">
                    ëŒ€ìš©ëŸ‰ íŒŒì¼ìš© ì‹¤ì‹œê°„ ìˆ˜ì‹  ëª¨ë“œì…ë‹ˆë‹¤.<br>
                    í”„ë ˆì„ì„ ìë™ íƒì§€í•˜ì—¬ <strong>ì‹¤ì‹œê°„ìœ¼ë¡œ ë³µì¡°</strong>í•©ë‹ˆë‹¤.
                </div>

                <!-- ì‹¤ì‹œê°„ ë ˆë²¨ë¯¸í„° (ë…¹ìŒ ì¤‘ì—ë§Œ í‘œì‹œ) -->
                <div id="level-meter-container" style="display:none">
                    <canvas id="level-canvas" height="40"></canvas>
                </div>

                <button id="btn-receive" class="primary-btn" onclick="onReceiveClick()">ìˆ˜ì‹  ëŒ€ê¸°</button>

                <!-- ì²­í¬ ì§„í–‰ë¥  íŒ¨ë„ (ìŠ¤íŠ¸ë¦¬ë° ìˆ˜ì‹  ì‹œ) -->
                <div id="chunk-progress" style="display:none">
                    <div class="chunk-stats">
                        <span id="chunk-count">0 / 0 ì²­í¬</span>
                        <span id="chunk-errors">ì˜¤ë¥˜: 0</span>
                        <span id="chunk-eta">ë‚¨ì€ ì‹œê°„: --</span>
                    </div>
                    <canvas id="chunk-bitmap-canvas" height="40"></canvas>
                    <p id="chunk-filename"></p>
                </div>

                <!-- íŒŒí˜• íŠ¸ë¦¬ë¨¸ (ìˆ˜ë™ ëª¨ë“œ, ë…¹ìŒ ì™„ë£Œ í›„ í‘œì‹œ) -->
                <div id="waveform-container" style="display:none">
                    <canvas id="waveform-canvas" height="120"></canvas>
                    <div class="trim-controls">
                        <input type="range" id="trim-start" min="0" max="1000" value="0">
                        <input type="range" id="trim-end" min="0" max="1000" value="1000">
                    </div>
                    <div class="trim-info">
                        <span id="trim-start-label">0.0s</span>
                        <span id="trim-duration-label"></span>
                        <span id="trim-end-label">0.0s</span>
                    </div>
                    <button id="btn-demodulate" class="primary-btn" onclick="demodulateTrimed()">ì„ íƒ êµ¬ê°„ ë³µì¡°</button>
                </div>

                <div id="received-files"></div>
            </div>

            <div id="progress-panel" class="card" style="display:none">
                <h2>ì§„í–‰</h2>
                <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
                <div class="progress-info">
                    <span id="progress-percent">0%</span>
                    <span id="progress-bytes"></span>
                </div>
                <p id="progress-message" class="progress-message"></p>
            </div>

            <div class="card">
                <h2>ë¡œê·¸</h2>
                <div id="log-container" class="log-container">
                    <div class="log-entry info">ë¸Œë¼ìš°ì € ì˜¤ë””ì˜¤ ëª¨ë€ ì¤€ë¹„ ì™„ë£Œ</div>
                </div>
            </div>
        </main>
    </div>

    <script src="modem.js"></script>
    <script src="app.js"></script>
</body>
</html>
